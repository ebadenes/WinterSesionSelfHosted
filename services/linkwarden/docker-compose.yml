services:
  linkwarden:
    image: ghcr.io/linkwarden/linkwarden:latest
    container_name: linkwarden
    restart: unless-stopped
    env_file:
      - ../../.env
    environment:
      - DATABASE_URL=postgresql://postgres:${LINKWARDEN_POSTGRES_PASSWORD}@linkwarden-db:5432/postgres
      - NEXTAUTH_URL=https://linkwarden.${BASE_DOMAIN}/api/v1/auth
      - NEXTAUTH_SECRET=${LINKWARDEN_NEXTAUTH_SECRET}
      - MEILI_MASTER_KEY=${LINKWARDEN_MEILI_MASTER_KEY}
      - MEILI_HOST=http://linkwarden-meili:7700
      - TZ=${TZ}
    volumes:
      - ${DATA_DIR}/linkwarden/data/app:/data/data
    depends_on:
      - linkwarden-db
      - linkwarden-meili
    networks:
      - proxy
      - backend
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.linkwarden.rule=Host(`linkwarden.${BASE_DOMAIN}`)
      - traefik.http.routers.linkwarden.entrypoints=websecure
      - traefik.http.routers.linkwarden.tls.certresolver=le
      - traefik.http.routers.linkwarden.middlewares=security-headers@docker
      - traefik.http.services.linkwarden.loadbalancer.server.port=3000
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  linkwarden-db:
    image: postgres:16-alpine
    container_name: linkwarden-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${LINKWARDEN_POSTGRES_PASSWORD}
    volumes:
      - ${DATA_DIR}/linkwarden/data/db:/var/lib/postgresql/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  linkwarden-meili:
    image: getmeili/meilisearch:v1.12.8
    container_name: linkwarden-meili
    restart: unless-stopped
    env_file:
      - ../../.env
    environment:
      - MEILI_MASTER_KEY=${LINKWARDEN_MEILI_MASTER_KEY}
    volumes:
      - ${DATA_DIR}/linkwarden/data/meilisearch:/meili_data
    networks:
      - backend
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

